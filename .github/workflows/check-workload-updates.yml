name: ðŸ” Check for Workload Updates

permissions:
  contents: read
  actions: write
  packages: read

on:
  schedule:
    - cron: '0 1 * * *'  # Daily at 1:00 AM UTC (before the build workflows)
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force building and pushing of all images regardless of existing tags'
        required: false
        default: false
        type: boolean

env:
  DOCKER_REPOSITORY_LINUX: ghcr.io/maui-containers/maui-linux
  DOCKER_REPOSITORY_WINDOWS: ghcr.io/maui-containers/maui-windows
  DOCKER_REPOSITORY_TEST: ghcr.io/maui-containers/maui-emulator-linux

jobs:
  check-updates:
    name: ðŸ” Check for New Workload Set Versions
    runs-on: ubuntu-latest
    outputs:
      trigger-builds: ${{ steps.aggregate-results.outputs.trigger-builds }}
      force-build: ${{ steps.aggregate-results.outputs.force-build }}

    steps:
    - name: ðŸ›’ Checkout
      uses: actions/checkout@v4

    - name: ðŸ” Check .NET 9.0 Workload Set Versions
      id: check-dotnet9
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if ("${{ inputs.force_build }}" -eq "true") {
          ./check-workload-updates.ps1 -DotnetVersion "9.0" -LinuxDockerRepository "${{ env.DOCKER_REPOSITORY_LINUX }}" -WindowsDockerRepository "${{ env.DOCKER_REPOSITORY_WINDOWS }}" -TestDockerRepository "${{ env.DOCKER_REPOSITORY_TEST }}" -ForceBuild
        } else {
          ./check-workload-updates.ps1 -DotnetVersion "9.0" -LinuxDockerRepository "${{ env.DOCKER_REPOSITORY_LINUX }}" -WindowsDockerRepository "${{ env.DOCKER_REPOSITORY_WINDOWS }}" -TestDockerRepository "${{ env.DOCKER_REPOSITORY_TEST }}"
        }

    - name: ðŸ” Check .NET 10.0 Workload Set Versions
      id: check-dotnet10
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if ("${{ inputs.force_build }}" -eq "true") {
          ./check-workload-updates.ps1 -DotnetVersion "10.0" -LinuxDockerRepository "${{ env.DOCKER_REPOSITORY_LINUX }}" -WindowsDockerRepository "${{ env.DOCKER_REPOSITORY_WINDOWS }}" -TestDockerRepository "${{ env.DOCKER_REPOSITORY_TEST }}" -ForceBuild
        } else {
          ./check-workload-updates.ps1 -DotnetVersion "10.0" -LinuxDockerRepository "${{ env.DOCKER_REPOSITORY_LINUX }}" -WindowsDockerRepository "${{ env.DOCKER_REPOSITORY_WINDOWS }}" -TestDockerRepository "${{ env.DOCKER_REPOSITORY_TEST }}"
        }

    - name: ðŸ“Š Aggregate Results
      id: aggregate-results
      shell: pwsh
      run: |
        $dotnet9TriggerBuilds = "${{ steps.check-dotnet9.outputs.trigger-builds }}"
        $dotnet10TriggerBuilds = "${{ steps.check-dotnet10.outputs.trigger-builds }}"
        $forceBuild = "${{ inputs.force_build }}"

        # Trigger builds if ANY .NET version has updates OR force build is enabled
        $triggerBuilds = ($dotnet9TriggerBuilds -eq "true") -or ($dotnet10TriggerBuilds -eq "true") -or ($forceBuild -eq "true")

        Write-Host "ðŸ” .NET 9.0 trigger builds: $dotnet9TriggerBuilds"
        Write-Host "ðŸ” .NET 10.0 trigger builds: $dotnet10TriggerBuilds"
        Write-Host "ðŸ” Force build: $forceBuild"
        Write-Host "ðŸ” Overall trigger builds: $triggerBuilds"

        echo "trigger-builds=$($triggerBuilds.ToString().ToLower())" >> $env:GITHUB_OUTPUT
        echo "force-build=$($forceBuild.ToString().ToLower())" >> $env:GITHUB_OUTPUT

  trigger-build-docker-linux:
    name: ðŸš€ Trigger Docker Linux Image Builds
    needs: check-updates
    if: needs.check-updates.outputs.trigger-builds == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Trigger Build Docker Linux Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('Triggering build-docker-linux workflow - workload update(s) detected');
          console.log('Each .NET version (9.0 and 10.0) will auto-detect its appropriate workload version');

          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-docker-linux.yml',
              ref: 'main',
              inputs: {}
            });
            console.log('âœ… Successfully triggered build-docker-linux workflow');
          } catch (error) {
            console.log(`âŒ Failed to trigger workflow: ${error.message}`);
            console.log('ðŸ”„ Trying alternative approach with repository dispatch...');

            // Alternative: Use repository dispatch
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'trigger-docker-linux-build',
              client_payload: {}
            });
            console.log('âœ… Successfully sent repository dispatch event');
          }

  trigger-build-docker-windows:
    name: ðŸš€ Trigger Docker Windows Image Builds
    needs: check-updates
    if: needs.check-updates.outputs.trigger-builds == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Trigger Build Docker Windows Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('Triggering build-docker-windows workflow - workload update(s) detected');
          console.log('Each .NET version (9.0 and 10.0) will auto-detect its appropriate workload version');

          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-docker-windows.yml',
              ref: 'main',
              inputs: {}
            });
            console.log('âœ… Successfully triggered build-docker-windows workflow');
          } catch (error) {
            console.log(`âŒ Failed to trigger workflow: ${error.message}`);
            console.log('ðŸ”„ Trying alternative approach with repository dispatch...');

            // Alternative: Use repository dispatch
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'trigger-docker-windows-build',
              client_payload: {}
            });
            console.log('âœ… Successfully sent repository dispatch event');
          }

  trigger-build-emulators:
    name: ðŸš€ Trigger Emulator Image Builds
    needs: check-updates
    if: needs.check-updates.outputs.trigger-builds == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Trigger Build Emulators Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('Triggering build-emulators workflow - workload update(s) detected');
          console.log('Each .NET version (9.0 and 10.0) will auto-detect its appropriate workload version');

          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main',
              inputs: {}
            });
            console.log('âœ… Successfully triggered build-emulators workflow');
          } catch (error) {
            console.log(`âŒ Failed to trigger workflow: ${error.message}`);
            console.log('ðŸ”„ Trying alternative approach with repository dispatch...');

            // Alternative: Use repository dispatch
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'trigger-emulators-build',
              client_payload: {}
            });
            console.log('âœ… Successfully sent repository dispatch event');
          }

  trigger-build-tart:
    name: ðŸš€ Trigger Tart VM Builds
    needs: check-updates
    if: needs.check-updates.outputs.trigger-builds == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet_channel: ['9.0', '10.0']

    steps:
    - name: ðŸš€ Trigger Tart VM Build for .NET ${{ matrix.dotnet_channel }}
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log(`Triggering Tart VM build for .NET ${{ matrix.dotnet_channel }}`);
          console.log('Note: .NET ${{ matrix.dotnet_channel }} will auto-detect its appropriate workload version');

          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-tart-vms.yml',
              ref: 'main',
              inputs: {
                dotnet_channel: '${{ matrix.dotnet_channel }}',
                image_type: 'maui',
                force_build: '${{ needs.check-updates.outputs.force-build }}'
              }
            });
            console.log('âœ… Successfully triggered Tart VM build for .NET ${{ matrix.dotnet_channel }}');
          } catch (error) {
            console.log(`âŒ Failed to trigger Tart VM build: ${error.message}`);
            throw error;
          }

  notify-results:
    name: ðŸ“¢ Notify Results
    needs: [check-updates, trigger-build-docker-linux, trigger-build-docker-windows, trigger-build-emulators, trigger-build-tart]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¢ Summary
      run: |
        echo "## Workload Update Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Check Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Builds triggered:** ${{ needs.check-updates.outputs.trigger-builds }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Force build:** ${{ needs.check-updates.outputs.force-build }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Individual .NET Version Checks" >> $GITHUB_STEP_SUMMARY
        echo "The workflow checked for workload updates for .NET 9.0 and 10.0 separately." >> $GITHUB_STEP_SUMMARY
        echo "Each .NET version auto-detects its appropriate workload version during builds." >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.check-updates.outputs.trigger-builds }}" == "true" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Linux image builds status:** ${{ needs.trigger-build-docker-linux.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Windows image builds status:** ${{ needs.trigger-build-docker-windows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Emulator image builds status:** ${{ needs.trigger-build-emulators.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tart VM builds status:** ${{ needs.trigger-build-tart.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check-updates.outputs.force-build }}" == "true" ]]; then
            echo "ðŸ”„ **Force build triggered!**" >> $GITHUB_STEP_SUMMARY
            echo "   - All images will be rebuilt regardless of existing tags" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **New workload set version(s) detected!**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggered Workflows:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Docker Linux Images** - Includes integrated GitHub/Gitea runner support" >> $GITHUB_STEP_SUMMARY
          echo "2. **Docker Windows Images** - Includes integrated GitHub/Gitea runner support" >> $GITHUB_STEP_SUMMARY
          echo "3. **Emulator Images** (Linux) - Android emulator with Appium" >> $GITHUB_STEP_SUMMARY
          echo "4. **Tart VM Images** (macOS) - MAUI development VMs with integrated runners" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **No new workload set versions found.** All builds are up to date." >> $GITHUB_STEP_SUMMARY
        fi
